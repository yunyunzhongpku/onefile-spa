<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•æ–‡ä»¶ SPA â€” ç¬”è®°ä¸å¾…åŠ</title>
  <!-- å¤–éƒ¨ manifestï¼šä¿ç•™ -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#4f46e5">
  <meta name="description" content="å•æ–‡ä»¶ SPA ç¤ºä¾‹ï¼šHash è·¯ç”±ã€æœ¬åœ°å­˜å‚¨ã€å¯¼å…¥å¯¼å‡ºã€æ·±æµ…è‰²ä¸»é¢˜ã€å¯é€‰ PWA å®‰è£…ã€‚" />
  <style>
    :root{
      --bg: #0b0c10;
      --panel: #151821;
      --text: #e6e6e6;
      --muted: #a3a3a3;
      --accent: #4f46e5;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --radius: 14px;
      --shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f7fb;
        --panel: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --accent: #4f46e5;
        --accent-2: #16a34a;
        --danger: #dc2626;
        --shadow: 0 6px 18px rgba(0,0,0,.08);
      }
    }
    [data-theme="dark"]{ --bg:#0b0c10; --panel:#151821; --text:#e6e6e6; --muted:#a3a3a3; }

    *{box-sizing:border-box}
    body{margin:0;font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}

    header{position:sticky;top:0;background:var(--bg);z-index:10}
    .topbar{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:14px 16px}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}

    .tabs{display:flex;gap:.5rem;padding:0 10px 10px}
    .tab{appearance:none;border:none;padding:10px 14px;border-radius:999px;background:transparent;color:var(--muted);cursor:pointer}
    .tab[aria-selected="true"]{background:var(--panel);box-shadow:var(--shadow);color:var(--text)}

    main{max-width:980px;margin:0 auto;padding:10px 16px 80px}

    .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1 1 280px}

    input[type="text"], textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:transparent;color:var(--text)}
    textarea{min-height:120px;resize:vertical}

    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);color:white}
    .btn.success{background:var(--accent-2);color:white}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(127,127,127,.25)}
    .btn.danger{background:var(--danger);color:white}
    .btn.icon{display:inline-flex;align-items:center;gap:.5rem}

    .list{display:grid;gap:10px;margin-top:12px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid rgba(127,127,127,.18);border-radius:12px}
    .item .left{display:flex;align-items:center;gap:10px}

    .muted{color:var(--muted)}
    .spacer{height:8px}
    .divider{height:1px;background:rgba(127,127,127,.18);margin:10px 0}

    footer.fabbar{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(to top, rgba(0,0,0,.12), transparent 30%), var(--bg);padding:8px 14px;border-top:1px solid rgba(127,127,127,.18);display:flex;gap:8px;justify-content:space-between}

    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:6px 10px;border-radius:999px;background:rgba(127,127,127,.15)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    @media (max-width:520px){ .hide-sm{ display:none } }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand" aria-label="å•æ–‡ä»¶ SPA">
      <div class="dot" aria-hidden="true"></div>
      <span>å•æ–‡ä»¶ SPA</span>
      <span class="chip" id="installChip" title="å¯å®‰è£…ä¸ºåº”ç”¨ï¼ˆå¯ç”¨æ—¶ï¼‰" hidden>å®‰è£…</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn ghost" id="themeBtn" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
    </div>
  </div>
  <nav class="tabs" role="tablist" aria-label="ä¸»åŒºåŸŸ">
    <button class="tab" role="tab" data-route="#notes" aria-selected="true">ğŸ“ ç¬”è®°</button>
    <button class="tab" role="tab" data-route="#todos" aria-selected="false">âœ… å¾…åŠ</button>
  </nav>
</header>

<main>
  <!-- Notes view -->
  <section id="view-notes" class="card" aria-labelledby="tab-notes">
    <h2>ç¬”è®°</h2>
    <div class="row">
      <input class="grow" type="text" id="noteTitle" placeholder="æ ‡é¢˜" aria-label="ç¬”è®°æ ‡é¢˜" />
    </div>
    <div class="spacer"></div>
    <textarea id="noteBody" placeholder="è¯·è¾“å…¥å†…å®¹â€¦" aria-label="ç¬”è®°æ­£æ–‡"></textarea>
    <div id="noteCount" class="muted">0 å­—</div>
    <div class="spacer"></div>
    <div class="row">
      <button class="btn primary" id="saveNote">ä¿å­˜ç¬”è®°</button>
      <input type="text" id="noteSearch" class="grow" placeholder="æœç´¢ç¬”è®°â€¦" aria-label="æœç´¢ç¬”è®°"/>
    </div>
    <div id="notesList" class="list" aria-live="polite"></div>
  </section>

  <div class="spacer"></div>

  <!-- Todos view -->
  <section id="view-todos" class="card" hidden>
    <h2>å¾…åŠ</h2>
    <div class="row">
      <input class="grow" type="text" id="todoInput" placeholder="æ–°çš„å¾…åŠâ€¦" aria-label="æ–°å¢å¾…åŠ" />
      <input type="date" id="todoDue" aria-label="æˆªæ­¢æ—¥æœŸ" />
      <button class="btn success" id="addTodo">æ·»åŠ </button>
    </div>
    <div class="divider"></div>
    <div class="row" style="align-items:center">
      <span class="muted">å‹¾é€‰åˆ‡æ¢å®ŒæˆçŠ¶æ€ï¼›é•¿æŒ‰åˆ é™¤ï¼ˆæ‰‹æœºï¼‰ã€‚</span>
      <span class="chip" id="todoStats">0 æœªå®Œæˆ â€¢ 0 å·²å®Œæˆ</span>
    </div>
    <div id="todosList" class="list" aria-live="polite"></div>
  </section>

  <div class="spacer"></div>

  <!-- About / Help view -->
</main>

<footer class="fabbar">
  <span class="muted">å•æ–‡ä»¶ SPA â€¢ <span id="footHash">#notes</span></span>
  <div style="display:flex;gap:8px">
    <a class="btn icon ghost" href="#notes">ğŸ“ ç¬”è®°</a>
    <a class="btn icon ghost" href="#todos">âœ… å¾…åŠ</a>
  </div>
</footer>

<script>
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // --- State & storage ---
  const STORAGE_KEY = 'onefile-spa-v1';
  const state = load() || { notes: [], todos: [], theme: null };

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch{ return null; } }
  function uid(){ return Math.random().toString(36).slice(2,9); }

  // --- Theme ---
  const themeBtn = $('#themeBtn');
  const applyTheme = () => {
    if(state.theme){ document.documentElement.setAttribute('data-theme', state.theme); }
    else{ document.documentElement.removeAttribute('data-theme'); }
  };
  themeBtn.addEventListener('click', () => { state.theme = state.theme === 'dark' ? 'light' : (state.theme === 'light' ? null : 'dark'); save(); applyTheme(); });
  applyTheme();

  // --- Router (hash-based) ---
  const routes = ['#notes','#todos'];
  const views = {
    '#notes': $('#view-notes'),
    '#todos': $('#view-todos'),
  };
  function setActive(route){
    routes.forEach(r => { views[r].hidden = (r !== route); });
    $$('.tab').forEach(btn => btn.setAttribute('aria-selected', String(btn.dataset.route === route)));
    $('#footHash').textContent = route;
  }
  function onHash(){
    const route = routes.includes(location.hash) ? location.hash : '#notes';
    setActive(route);
  }
  window.addEventListener('hashchange', onHash);
  $$('.tab').forEach(btn => btn.addEventListener('click', () => { location.hash = btn.dataset.route; }));
  onHash();

  // --- Notes ---
  const noteTitle = $('#noteTitle');
  const noteBody = $('#noteBody');
  const noteCount = $('#noteCount');
  function updateNoteCount() {
    const len = (noteTitle.value.trim().length + noteBody.value.trim().length);
    if (noteCount) noteCount.textContent = `${len} å­—`;
  }
  noteTitle.addEventListener('input', updateNoteCount);
  noteBody.addEventListener('input', updateNoteCount);
  updateNoteCount();
  const notesList = $('#notesList');
  const noteSearch = $('#noteSearch');

  function renderNotes(){
    const q = (noteSearch.value || '').toLowerCase();
    const filtered = state.notes.filter(n => (n.title + ' ' + n.body).toLowerCase().includes(q));
    notesList.innerHTML = '';
    if(!filtered.length){
      notesList.innerHTML = `<div class="muted">æš‚æ— ç¬”è®°ã€‚</div>`;
      return;
    }
    for (const n of filtered.sort((a,b) => (Number(b.pinned) - Number(a.pinned)) || (b.updated - a.updated))) {
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div class="left">
          <div>
            <div style="font-weight:600">${escapeHTML(n.title) || '(æ— æ ‡é¢˜)'} </div>
            <div class="muted" style="font-size:.9em;max-width:56ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHTML(n.body)}</div>
          </div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" data-pin="${n.id}">${n.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}</button>
          <button class="btn ghost" data-edit="${n.id}">ç¼–è¾‘</button>
          <button class="btn danger" data-del="${n.id}">åˆ é™¤</button>
        </div>
      `;
      notesList.appendChild(el);
    }
  }

  function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  $('#saveNote').addEventListener('click', () => {
    const title = noteTitle.value.trim();
    const body = noteBody.value.trim();
    if(!title && !body){ noteTitle.focus(); return; }
    const existing = state._editingNoteId && state.notes.find(n=>n.id===state._editingNoteId);
    if(existing){ existing.title = title; existing.body = body; existing.updated = Date.now(); state._editingNoteId = null; }
    else { state.notes.push({ id: uid(), title, body, created: Date.now(), updated: Date.now(), pinned: false });}
    save(); noteTitle.value=''; noteBody.value=''; renderNotes();
  });

  notesList.addEventListener('click', (e)=>{
    const t = e.target;
    if(t.dataset.del){
      const id = t.dataset.del; state.notes = state.notes.filter(n=>n.id!==id); save(); renderNotes();
    }
    if(t.dataset.edit){
      const id = t.dataset.edit; const n = state.notes.find(n=>n.id===id);
      if(n){ noteTitle.value = n.title; noteBody.value = n.body; state._editingNoteId = id; location.hash = '#notes'; }
    }
    if (t.dataset.pin) {
      const n = state.notes.find(x => x.id === t.dataset.pin);
      if (n) { n.pinned = !n.pinned; n.updated = Date.now(); save(); renderNotes(); }
    }
  });

  noteSearch.addEventListener('input', renderNotes);
  renderNotes();

  // --- Todos ---
  const todoInput = $('#todoInput');
  const addTodoBtn = $('#addTodo');
  const todosList = $('#todosList');
  const todoStats = $('#todoStats');
  const todoDue = $('#todoDue');

  function renderTodos(){
    todosList.innerHTML = '';
    if(!state.todos.length){ todosList.innerHTML = `<div class="muted">æš‚æ— å¾…åŠã€‚</div>`; updateTodoStats(); return; }
    for(const t of state.todos){
      const el = document.createElement('div');
      el.className = 'item';
      const due = t.due ? new Date(t.due) : null;
      const today = new Date(); today.setHours(0,0,0,0);
      const overdue = due ? (due.getTime() < today.getTime() && !t.done) : false;
      el.innerHTML = `
        <div class="left">
          <input type="checkbox" ${t.done? 'checked':''} data-toggle="${t.id}" aria-label="åˆ‡æ¢å¾…åŠå®ŒæˆçŠ¶æ€" />
          <div ${t.done? 'style="text-decoration:line-through;opacity:.7"':''}>
            ${escapeHTML(t.text)}
            ${t.due ? `<span class="chip" style="margin-left:8px; ${overdue ? 'background:rgba(239,68,68,.25);border:1px solid rgba(239,68,68,.5)' : ''}">æˆªæ­¢ï¼š${t.due}${overdue ? 'ï¼ˆå·²é€¾æœŸï¼‰' : ''}</span>` : ''}
          </div>
        </div>
        <button class="btn ghost" data-del-todo="${t.id}" title="åˆ é™¤">ğŸ—‘ï¸</button>
      `;
      let pressTimer;
      el.addEventListener('touchstart', () => { pressTimer = setTimeout(()=>{ delTodo(t.id); }, 500); }, {passive:true});
      el.addEventListener('touchend', () => clearTimeout(pressTimer));
      todosList.appendChild(el);
    }
    updateTodoStats();
  }
  function updateTodoStats(){
    const open = state.todos.filter(t=>!t.done).length;
    const done = state.todos.length - open;
    todoStats.textContent = `${open} æœªå®Œæˆ â€¢ ${done} å·²å®Œæˆ`;
  }
  function delTodo(id){ state.todos = state.todos.filter(t=>t.id!==id); save(); renderTodos(); }

  addTodoBtn.addEventListener('click', ()=>{
    const text = (todoInput.value || '').trim(); 
    if(!text) return;
    state.todos.push({
      id: uid(), 
      text, 
      done:false, 
      created: Date.now(), 
      due: (todoDue?.value || '')
    });
    save();                 // âœ… ä¿å­˜åˆ° localStorage
    todoInput.value = '';   // âœ… æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼Œä½†ä½“éªŒå¥½ï¼‰
    if (todoDue) todoDue.value = '';
    renderTodos();          // âœ… é‡æ–°æ¸²æŸ“åˆ—è¡¨
  });
  todosList.addEventListener('click', (e)=>{
    const t = e.target;
    if(t.dataset.toggle){ const x = state.todos.find(v=>v.id===t.dataset.toggle); if(x){ x.done=!x.done; save(); renderTodos(); } }
    if(t.dataset.delTodo){ delTodo(t.dataset.delTodo); }
  });
  todoInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addTodoBtn.click(); }});
  renderTodos();

  // --- Export / Import / Reset ---
  $('#exportBtn')?.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'onefile-spa-data.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  });
  $('#importFile')?.addEventListener('change', async (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if(!data || typeof data !== 'object') throw new Error('æ•°æ®æ— æ•ˆ');
      state.notes = Array.isArray(data.notes)? data.notes : state.notes;
      state.todos = Array.isArray(data.todos)? data.todos : state.todos;
      if(['dark','light',null].includes(data.theme)) state.theme = data.theme;
      save(); applyTheme(); renderNotes(); renderTodos(); alert('å·²å¯¼å…¥');
    }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message); }
    ev.target.value='';
  });
  $('#resetBtn')?.addEventListener('click', ()=>{
    if(confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚')){ localStorage.removeItem(STORAGE_KEY); location.reload(); }
  });

  // âœ… æ—§çš„â€œBlob æ³¨å…¥ manifest/SW/å®‰è£…æç¤º/makeIconSVGURLâ€æ•´å—å·²åˆ é™¤
})();
</script>

<!-- âœ… å¤–éƒ¨ sw.js çš„æ³¨å†Œï¼ˆä¿ç•™ï¼Œç”¨è¿™ä¸ªï¼‰ -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}
</script>
</body>
</html>
