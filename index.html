<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>单文件 SPA — 笔记与待办</title>
  <!-- 外部 manifest：保留 -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#4f46e5">
  <meta name="description" content="单文件 SPA 示例：Hash 路由、本地存储、导入导出、深浅色主题、可选 PWA 安装。" />
  <style>
    :root{
      --bg: #0b0c10;
      --panel: #151821;
      --text: #e6e6e6;
      --muted: #a3a3a3;
      --accent: #4f46e5;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --radius: 14px;
      --shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f7fb;
        --panel: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --accent: #4f46e5;
        --accent-2: #16a34a;
        --danger: #dc2626;
        --shadow: 0 6px 18px rgba(0,0,0,.08);
      }
    }
    [data-theme="dark"]{ --bg:#0b0c10; --panel:#151821; --text:#e6e6e6; --muted:#a3a3a3; }

    *{box-sizing:border-box}
    body{margin:0;font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}

    header{position:sticky;top:0;background:var(--bg);z-index:10}
    .topbar{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:14px 16px}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}

    .tabs{display:flex;gap:.5rem;padding:0 10px 10px}
    .tab{appearance:none;border:none;padding:10px 14px;border-radius:999px;background:transparent;color:var(--muted);cursor:pointer}
    .tab[aria-selected="true"]{background:var(--panel);box-shadow:var(--shadow);color:var(--text)}

    main{max-width:980px;margin:0 auto;padding:10px 16px 80px}

    .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1 1 280px}

    input[type="text"], textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:transparent;color:var(--text)}
    textarea{min-height:120px;resize:vertical}

    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);color:white}
    .btn.success{background:var(--accent-2);color:white}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(127,127,127,.25)}
    .btn.danger{background:var(--danger);color:white}
    .btn.icon{display:inline-flex;align-items:center;gap:.5rem}

    .list{display:grid;gap:10px;margin-top:12px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid rgba(127,127,127,.18);border-radius:12px}
    .item .left{display:flex;align-items:center;gap:10px}

    .muted{color:var(--muted)}
    .spacer{height:8px}
    .divider{height:1px;background:rgba(127,127,127,.18);margin:10px 0}

    footer.fabbar{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(to top, rgba(0,0,0,.12), transparent 30%), var(--bg);padding:8px 14px;border-top:1px solid rgba(127,127,127,.18);display:flex;gap:8px;justify-content:space-between}

    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:6px 10px;border-radius:999px;background:rgba(127,127,127,.15)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    @media (max-width:520px){ .hide-sm{ display:none } }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand" aria-label="单文件 SPA">
      <div class="dot" aria-hidden="true"></div>
      <span>单文件 SPA</span>
      <span class="chip" id="installChip" title="可安装为应用（可用时）" hidden>安装</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn ghost" id="themeBtn" aria-label="切换主题">🌓</button>
      <a class="btn ghost hide-sm" href="#about">帮助</a>
    </div>
  </div>
  <nav class="tabs" role="tablist" aria-label="主区域">
    <button class="tab" role="tab" data-route="#notes" aria-selected="true">📝 笔记</button>
    <button class="tab" role="tab" data-route="#todos" aria-selected="false">✅ 待办</button>
    <button class="tab" role="tab" data-route="#about" aria-selected="false">❓ 帮助</button>
  </nav>
</header>

<main>
  <!-- Notes view -->
  <section id="view-notes" class="card" aria-labelledby="tab-notes">
    <h2>笔记</h2>
    <div class="row">
      <input class="grow" type="text" id="noteTitle" placeholder="标题" aria-label="笔记标题" />
    </div>
    <div class="spacer"></div>
    <textarea id="noteBody" placeholder="请输入内容…" aria-label="笔记正文"></textarea>
    <div class="spacer"></div>
    <div class="row">
      <button class="btn primary" id="saveNote">保存笔记</button>
      <input type="text" id="noteSearch" class="grow" placeholder="搜索笔记…" aria-label="搜索笔记"/>
    </div>
    <div id="notesList" class="list" aria-live="polite"></div>
  </section>

  <div class="spacer"></div>

  <!-- Todos view -->
  <section id="view-todos" class="card" hidden>
    <h2>待办</h2>
    <div class="row">
      <input class="grow" type="text" id="todoInput" placeholder="新的待办…" aria-label="新增待办" />
      <button class="btn success" id="addTodo">添加</button>
    </div>
    <div class="divider"></div>
    <div class="row" style="align-items:center">
      <span class="muted">勾选切换完成状态；长按删除（手机）。</span>
      <span class="chip" id="todoStats">0 未完成 • 0 已完成</span>
    </div>
    <div id="todosList" class="list" aria-live="polite"></div>
  </section>

  <div class="spacer"></div>

  <!-- About / Help view -->
  <section id="view-about" class="card" hidden>
    <h2>关于本示例</h2>
    <p>这是一个<strong>单文件 SPA</strong>，演示了：</p>
    <ul>
      <li><strong>Hash 路由</strong>：通过 URL hash（#notes、#todos、#about）切换视图。</li>
      <li><strong>状态</strong>保存在 <code>localStorage</code>（刷新/重启后仍保留）。</li>
      <li><strong>导出/导入</strong> 数据为 JSON 文件。</li>
      <li><strong>深浅色主题</strong>切换与响应式布局。</li>
      <li><strong>可选 PWA 安装</strong>（需经由 http/https 访问）。</li>
    </ul>

    <h3>使用说明</h3>
    <ol>
      <li><strong>电脑</strong>：直接用浏览器打开该 HTML 文件即可，核心功能可用。<br><em>提示：</em> 安装/离线 功能需要通过 http/https 访问（不是 file://）。如需此功能，把文件放到任意静态托管或本地起一个服务器。</li>
      <li><strong>Android（安卓）</strong>：在 Chrome 打开即可使用；若通过 https 访问，你可能会看到 <em>安装</em> 提示。</li>
    </ol>

    <div class="divider"></div>

    <div class="row">
      <button class="btn ghost" id="exportBtn">导出数据</button>
      <label class="btn ghost" for="importFile">导入数据</label>
      <input id="importFile" type="file" accept="application/json" class="sr-only" />
      <button class="btn danger" id="resetBtn" title="清空所有本地数据">清空</button>
    </div>

    <p class="muted" style="margin-top:8px">存储键：<code>onefile-spa-v1</code></p>
  </section>
</main>

<footer class="fabbar">
  <span class="muted">单文件 SPA • <span id="footHash">#notes</span></span>
  <div style="display:flex;gap:8px">
    <a class="btn icon ghost" href="#notes">📝 笔记</a>
    <a class="btn icon ghost" href="#todos">✅ 待办</a>
    <a class="btn icon ghost" href="#about">❓ 帮助</a>
  </div>
</footer>

<script>
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // --- State & storage ---
  const STORAGE_KEY = 'onefile-spa-v1';
  const state = load() || { notes: [], todos: [], theme: null };

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch{ return null; } }
  function uid(){ return Math.random().toString(36).slice(2,9); }

  // --- Theme ---
  const themeBtn = $('#themeBtn');
  const applyTheme = () => {
    if(state.theme){ document.documentElement.setAttribute('data-theme', state.theme); }
    else{ document.documentElement.removeAttribute('data-theme'); }
  };
  themeBtn.addEventListener('click', () => { state.theme = state.theme === 'dark' ? 'light' : (state.theme === 'light' ? null : 'dark'); save(); applyTheme(); });
  applyTheme();

  // --- Router (hash-based) ---
  const routes = ['#notes','#todos','#about'];
  const views = {
    '#notes': $('#view-notes'),
    '#todos': $('#view-todos'),
    '#about': $('#view-about'),
  };
  function setActive(route){
    routes.forEach(r => { views[r].hidden = (r !== route); });
    $$('.tab').forEach(btn => btn.setAttribute('aria-selected', String(btn.dataset.route === route)));
    $('#footHash').textContent = route;
  }
  function onHash(){
    const route = routes.includes(location.hash) ? location.hash : '#notes';
    setActive(route);
  }
  window.addEventListener('hashchange', onHash);
  $$('.tab').forEach(btn => btn.addEventListener('click', () => { location.hash = btn.dataset.route; }));
  onHash();

  // --- Notes ---
  const noteTitle = $('#noteTitle');
  const noteBody = $('#noteBody');
  const notesList = $('#notesList');
  const noteSearch = $('#noteSearch');

  function renderNotes(){
    const q = (noteSearch.value || '').toLowerCase();
    const filtered = state.notes.filter(n => (n.title + ' ' + n.body).toLowerCase().includes(q));
    notesList.innerHTML = '';
    if(!filtered.length){
      notesList.innerHTML = `<div class="muted">暂无笔记。</div>`;
      return;
    }
    for(const n of filtered.sort((a,b)=>b.updated-a.updated)){
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div class="left">
          <div>
            <div style="font-weight:600">${escapeHTML(n.title) || '(无标题)'} </div>
            <div class="muted" style="font-size:.9em;max-width:56ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHTML(n.body)}</div>
          </div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" data-edit="${n.id}">编辑</button>
          <button class="btn danger" data-del="${n.id}">删除</button>
        </div>
      `;
      notesList.appendChild(el);
    }
  }

  function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  $('#saveNote').addEventListener('click', () => {
    const title = noteTitle.value.trim();
    const body = noteBody.value.trim();
    if(!title && !body){ noteTitle.focus(); return; }
    const existing = state._editingNoteId && state.notes.find(n=>n.id===state._editingNoteId);
    if(existing){ existing.title = title; existing.body = body; existing.updated = Date.now(); state._editingNoteId = null; }
    else { state.notes.push({ id: uid(), title, body, created: Date.now(), updated: Date.now() }); }
    save(); noteTitle.value=''; noteBody.value=''; renderNotes();
  });

  notesList.addEventListener('click', (e)=>{
    const t = e.target;
    if(t.dataset.del){
      const id = t.dataset.del; state.notes = state.notes.filter(n=>n.id!==id); save(); renderNotes();
    }
    if(t.dataset.edit){
      const id = t.dataset.edit; const n = state.notes.find(n=>n.id===id);
      if(n){ noteTitle.value = n.title; noteBody.value = n.body; state._editingNoteId = id; location.hash = '#notes'; }
    }
  });

  noteSearch.addEventListener('input', renderNotes);
  renderNotes();

  // --- Todos ---
  const todoInput = $('#todoInput');
  const addTodoBtn = $('#addTodo');
  const todosList = $('#todosList');
  const todoStats = $('#todoStats');

  function renderTodos(){
    todosList.innerHTML = '';
    if(!state.todos.length){ todosList.innerHTML = `<div class="muted">暂无待办。</div>`; updateTodoStats(); return; }
    for(const t of state.todos){
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div class="left">
          <input type="checkbox" ${t.done? 'checked':''} data-toggle="${t.id}" aria-label="切换待办完成状态" />
          <div ${t.done? 'style="text-decoration:line-through;opacity:.7"':''}>${escapeHTML(t.text)}</div>
        </div>
        <button class="btn ghost" data-del-todo="${t.id}" title="删除">🗑️</button>
      `;
      let pressTimer;
      el.addEventListener('touchstart', () => { pressTimer = setTimeout(()=>{ delTodo(t.id); }, 500); }, {passive:true});
      el.addEventListener('touchend', () => clearTimeout(pressTimer));
      todosList.appendChild(el);
    }
    updateTodoStats();
  }
  function updateTodoStats(){
    const open = state.todos.filter(t=>!t.done).length;
    const done = state.todos.length - open;
    todoStats.textContent = `${open} 未完成 • ${done} 已完成`;
  }
  function delTodo(id){ state.todos = state.todos.filter(t=>t.id!==id); save(); renderTodos(); }

  addTodoBtn.addEventListener('click', ()=>{
    const text = (todoInput.value || '').trim(); if(!text) return;
    state.todos.push({ id: uid(), text, done:false, created: Date.now() }); save(); todoInput.value=''; renderTodos();
  });
  todosList.addEventListener('click', (e)=>{
    const t = e.target;
    if(t.dataset.toggle){ const x = state.todos.find(v=>v.id===t.dataset.toggle); if(x){ x.done=!x.done; save(); renderTodos(); } }
    if(t.dataset.delTodo){ delTodo(t.dataset.delTodo); }
  });
  todoInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addTodoBtn.click(); }});
  renderTodos();

  // --- Export / Import / Reset ---
  $('#exportBtn')?.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'onefile-spa-data.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  });
  $('#importFile')?.addEventListener('change', async (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if(!data || typeof data !== 'object') throw new Error('数据无效');
      state.notes = Array.isArray(data.notes)? data.notes : state.notes;
      state.todos = Array.isArray(data.todos)? data.todos : state.todos;
      if(['dark','light',null].includes(data.theme)) state.theme = data.theme;
      save(); applyTheme(); renderNotes(); renderTodos(); alert('已导入');
    }catch(err){ alert('导入失败：' + err.message); }
    ev.target.value='';
  });
  $('#resetBtn')?.addEventListener('click', ()=>{
    if(confirm('确认清空所有数据？该操作不可恢复。')){ localStorage.removeItem(STORAGE_KEY); location.reload(); }
  });

  // ✅ 旧的“Blob 注入 manifest/SW/安装提示/makeIconSVGURL”整块已删除
})();
</script>

<!-- ✅ 外部 sw.js 的注册（保留，用这个） -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}
</script>
</body>
</html>
